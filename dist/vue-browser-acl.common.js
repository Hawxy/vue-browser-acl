"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const t="GLOBAL_RULE",e=e=>"boolean"==typeof e||void 0===e||"function"==typeof e&&""===e.name;class Acl{constructor({strict:e=!1}={}){this.strict=e,this.rules=new Map,this.policies=new Map,this.registry=new WeakMap}rule(r,o,i=!0){e(o)&&(i=void 0===o||o,o=t);const s=this.subjectMapper(o);return(Array.isArray(r)?r:[r]).forEach(e=>{const t=this.rules.get(s)||{};t[e]=i,this.rules.set(s,t)}),this}policy(e,t){const r="function"==typeof e?new e:e,o=this.subjectMapper(t);return this.policies.set(o,r),this}register(e,t){return this.registry.set(e,t),this}can(e,r,o,...i){o=void 0===o?t:o;const s=this.subjectMapper(o),n=this.policies.get(s),c=n||this.rules.get(s);if(void 0===c){if(this.strict)throw new Error(`Unknown subject "${s}"`);return!1}if(n&&"function"==typeof n.beforeAll){const t=n.beforeAll(r,e,o,s,...i);if(void 0!==t)return t}if("function"==typeof c[r])return Boolean(c[r](e,o,s,...i));if(this.strict&&void 0===c[r])throw new Error(`Unknown verb "${r}"`);return Boolean(c[r])}some(e,t,r,...o){return r.some(r=>this.can(e,t,r,...o))}every(e,t,r,...o){return r.every(r=>this.can(e,t,r,...o))}mixin(e){const t=this;return e.prototype.can=function(){return t.can(this,...arguments)},e.prototype.can.every=function(){return t.every(this,...arguments)},e.prototype.can.some=function(){return t.some(this,...arguments)},this}subjectMapper(e){if("string"==typeof e)return e;const t="function"==typeof e;return t&&this.registry.has(e)?this.registry.get(e):!t&&this.registry.has(e.constructor)?this.registry.get(e.constructor):t?e.name:e.constructor.name}reset(){return this.rules=new Map,this.policies=new Map,this.registry=new WeakMap,this}removeRules(e,t=null){const r=this.subjectMapper(e);if(this.rules.has(r)){if(t)return delete this.rules.get(r)[t],this;this.rules.delete(r)}return this}removePolicy(e){const t=this.subjectMapper(e);return this.policies.delete(t),this}removeAll(e){return this.removeRules(e),this.removePolicy(e),this}}var index={install:function(e,r,o,i={}){const s="function"==typeof r?r:()=>r,n=Boolean(i.strict);i=Object.assign({acl:{strict:n},assumeGlobal:!n,caseMode:!0,debug:!1,directive:"can",failRoute:"/",helper:!0,strict:!1},i);let c=o;if(o instanceof Acl||o(c=new Acl(i.acl)),c.router=function(e){i.router=e;const r=(e,t,...r)=>t&&c.can(s(),e,t,...r)||!t&&!i.strict,o=(e,o,s)=>{let n=null;const c=e.reduce((e,c)=>e.then(e=>{if(!0!==e)return e;n=c.fail;const a="function"==typeof c.can?c.can(o,s,r):Promise.resolve(r(...(e=>{const[r=null,o=(i.assumeGlobal?t:null)]=(e.can||"").split(" ");return[r,o]})(c)));if(i.strict&&!(a instanceof Promise))throw new Error("$route.meta.can must return a promise in strict mode");return a}).catch(e=>(i.debug&&console.error(e),!1)),Promise.resolve(!0));return c.getFail=()=>n,c};e.beforeEach((e,t,r)=>{const s=e.matched.filter(e=>e.meta&&e.meta.can).map(e=>e.meta),n=o(s,e,t);n.then(e=>{if(!0===e)return r();const o="$from"===n.getFail()?t.path:n.getFail();r(o||i.failRoute)})})},i.router&&c.router(i.router),e.directive(i.directive,function(e,r,o){const n=r.modifiers.disable?"disable":"hide";let a,l,u,p;if(l=r.arg,Array.isArray(r.value)?[a,u,p]=r.modifiers.global?arrayToGlobalExprTpl(r):arrayToExprTpl(r):"string"==typeof r.value?[a,u,p]=stringToExprTpl(r,o,i):l&&"object"==typeof r.value?(a=l,u=r.value,p=[]):void 0===r.value&&!r.modifiers.global&&i.assumeGlobal&&(a=l,u=t,p=[]),i.assumeGlobal&&!u&&(u=t,p=p||[],a=a||l),!a||!u)throw new Error("Missing verb or subject");const f=(r.modifiers.some?"some":r.modifiers.every&&"every")||"can",h=c[f](s(),a,u,...p),d=r.modifiers.not;(h&&d||!h&&!d)&&("hide"===n?commentNode(e,o):"disable"===n?e.disabled=!0:"readonly"===n&&(e.readOnly=!0))}),i.helper){const t=`$${i.directive}`;e.prototype[t]=function(){return c.can(s(),...arguments)},e.prototype[t].not=function(){return!c.can(s(),...arguments)},e.prototype[t].every=function(){return c.every(s(),...arguments)},e.prototype[t].some=function(){return c.some(s(),...arguments)}}}};function commentNode(e,t){const r=document.createComment(" ");Object.defineProperty(r,"setAttribute",{value:()=>void 0}),t.text=" ",t.elm=r,t.isComment=!0,t.tag=void 0,t.data.directives=void 0,t.componentInstance&&(t.componentInstance.$el=r),e.parentNode&&e.parentNode.replaceChild(r,e)}const arrayToExprTpl=({arg:e,value:t})=>[e||t[0],e?t[0]:t[1],e?t.slice(1):t.slice(2)],arrayToGlobalExprTpl=({arg:e,value:r})=>[e||r[0],t,e?r:r.slice(1)],stringToExprTpl=({arg:e,value:t,modifiers:r},o,i)=>{let[s,n]=e?[e,t]:t.split(" ");if(n&&r.global)throw new Error("You cannot provide subject and use global modifier at the same time");return"string"==typeof n&&i.caseMode&&n[0].match(/[a-z]/)&&(n=o.context[n]),[s,n,[]]};exports.default=index;
//# sourceMappingURL=vue-browser-acl.common.js.map
