{"version":3,"file":"vue-browser-acl.umd.js","sources":["../node_modules/browser-acl/dist/browser-acl.esm.js","../index.js"],"sourcesContent":["const t=\"GLOBAL_RULE\",e=t=>\"boolean\"==typeof t||void 0===t||\"function\"==typeof t&&\"\"===t.name;export default class{constructor({strict:t=!1}={}){this.strict=t,this.rules=new Map,this.policies=new Map,this.registry=new WeakMap}rule(r,s,i=!0){e(s)&&(i=void 0===s||s,s=t);const n=this.subjectMapper(s);return(Array.isArray(r)?r:[r]).forEach(t=>{const e=this.rules.get(n)||{};e[t]=i,this.rules.set(n,e)}),this}policy(t,e){const r=\"function\"==typeof t?new t:t,s=this.subjectMapper(e);return this.policies.set(s,r),this}register(t,e){return this.registry.set(t,e),this}can(e,r,s,...i){s=void 0===s?t:s;const n=this.subjectMapper(s),o=this.policies.get(n),c=o||this.rules.get(n);if(void 0===c){if(this.strict)throw new Error(`Unknown subject \"${n}\"`);return!1}if(o&&\"function\"==typeof o.beforeAll){const t=o.beforeAll(r,e,s,n,...i);if(void 0!==t)return t}if(\"function\"==typeof c[r])return Boolean(c[r](e,s,n,...i));if(this.strict&&void 0===c[r])throw new Error(`Unknown verb \"${r}\"`);return Boolean(c[r])}some(t,e,r,...s){return r.some(r=>this.can(t,e,r,...s))}every(t,e,r,...s){return r.every(r=>this.can(t,e,r,...s))}mixin(t){const e=this;return t.prototype.can=function(){return e.can(this,...arguments)},t.prototype.can.every=function(){return e.every(this,...arguments)},t.prototype.can.some=function(){return e.some(this,...arguments)},this}subjectMapper(t){if(\"string\"==typeof t)return t;const e=\"function\"==typeof t;return e&&this.registry.has(t)?this.registry.get(t):!e&&this.registry.has(t.constructor)?this.registry.get(t.constructor):e?t.name:t.constructor.name}reset(){return this.rules=new Map,this.policies=new Map,this.registry=new WeakMap,this}removeRules(t,e=null){const r=this.subjectMapper(t);if(this.rules.has(r)){if(e){return delete this.rules.get(r)[e],this}this.rules.delete(r)}return this}removePolicy(t){const e=this.subjectMapper(t);return this.policies.delete(e),this}removeAll(t){return this.removeRules(t),this.removePolicy(t),this}}export{t as GlobalRule};\n//# sourceMappingURL=browser-acl.esm.js.map\n","import Acl, { GlobalRule } from 'browser-acl'\n\n/**\n * VueAcl constructor function\n *\n * ```javascript\n * import Vue from 'vue'\n * import Acl from 'vue-browser-acl'\n *\n * Vue.use(Acl, user, (acl) => {\n *   acl.rule(view, Post)\n *   acl.rule([edit, delete], Post, (user, post) => post.userId === user.id)\n *   acl.rule('moderate', Post, (user) => user.isModerator())\n * })\n * ```\n *\n * @access public\n * @param {Function|Object} user A user instance or a function that returns the user\n * @param {Function|Object} setupCallback A configured Acl instance or a callback callback that adds rules and policies.\n * @param {Object}   options={}\n * @param {Object}  [options.acl={}] Options passed to the Acl constructor\n * @param {Boolean} [options.assumeGlobal=true] If no subject is specified in route assume it is a global rule\n * @param {Boolean} [options.caseMode=true] When true lower case subjects will be looked up on the vue context\n * @param {Boolean} [options.debug=false] Outputs errors and other useful information to the console\n * @param {Boolean} [options.directive='can'] Name of the directive, and helper function\n * @param {String}  [options.failRoute='/'] Set a default fail route\n * @param {Boolean} [options.helper=true] Adds helper function\n * @param {Boolean} [options.strict=false] Causes redirect to fail route if route permissions are absent\n * @param {?Object}  options.router Vue router\n */\nexport default {\n  install: function (Vue, user, setupCallback, options = {}) {\n    /* ensure userAccessor is function */\n    const userAccessor = typeof user === 'function' ? user : () => user\n\n    /* defaults */\n    const strict = Boolean(options.strict)\n    options = Object.assign(\n      {\n        acl: { strict },\n        assumeGlobal: !strict,\n        caseMode: true,\n        debug: false,\n        directive: 'can',\n        failRoute: '/',\n        helper: true,\n        strict: false,\n      },\n      options\n    )\n\n    /* setup acl */\n    let acl = setupCallback\n    if (!(setupCallback instanceof Acl)) {\n      acl = new Acl(options.acl)\n      setupCallback(acl)\n    }\n\n    /* router init function */\n    acl.router = function (router) {\n      options.router = router\n\n      const canNavigate = (verb, subject, ...otherArgs) => {\n        return (subject && acl.can(userAccessor(), verb, subject, ...otherArgs)) ||\n          (!subject && !options.strict)\n      }\n\n      /* convert 'edit Post' to ['edit', 'Post'] */\n      const metaToStatementPair = meta => {\n        const [\n          verb = null,\n          subject = options.assumeGlobal ? GlobalRule : null\n        ] = (meta.can || '').split(' ')\n        return [verb, subject]\n      }\n\n      /**\n       * chain all can-statements and functions as promises\n       * each can-function must return a promise (in strict\n       * mode at least). To break the chain return a none\n       * true value\n       */\n      const chainCans = (metas, to, from) => {\n        let fail = null\n        const chain = metas.reduce((chain, meta) => {\n          return chain\n            .then(result => {\n              if (result !== true) {\n                return result\n              }\n\n              fail = meta.fail\n\n              const nextPromise = typeof meta.can === 'function'\n                ? meta.can(to, from, canNavigate)\n                : Promise.resolve(canNavigate(...metaToStatementPair(meta)))\n\n              if (options.strict && !(nextPromise instanceof Promise)) {\n                throw new Error('$route.meta.can must return a promise in strict mode')\n              }\n\n              return nextPromise\n            })\n            // convert errors to false\n            .catch(error => {\n              if (options.debug) {\n                console.error(error)\n              }\n              return false\n            })\n        }, Promise.resolve(true))\n        chain.getFail = () => fail\n        return chain\n      }\n\n      router.beforeEach((to, from, next) => {\n        const metas = to.matched\n          .filter(route => route.meta && route.meta.can)\n          .map(route => route.meta)\n\n        const chain = chainCans(metas, to, from)\n        chain.then(result => {\n          if (result === true) {\n            return next()\n          }\n          const fail = chain.getFail() === '$from'\n            ? from.path\n            : chain.getFail()\n          next(fail || options.failRoute)\n        })\n      })\n    }\n\n    /* init router */\n    if (options.router) {\n      acl.router(options.router)\n    }\n\n    /* create directive */\n    Vue.directive(options.directive, function(el, binding, vnode) {\n      const behaviour = binding.modifiers.disable ? 'disable' : 'hide'\n\n      let verb, verbArg, subject, params\n      verbArg = binding.arg\n      if (Array.isArray(binding.value)) {\n        [verb, subject, params] = binding.modifiers.global\n          ? arrayToGlobalExprTpl(binding)\n          : arrayToExprTpl(binding)\n      } else if (typeof binding.value === 'string') {\n        [verb, subject, params] = stringToExprTpl(binding, vnode, options)\n      } else if (verbArg && typeof binding.value === 'object') {\n        verb = verbArg\n        subject = binding.value\n        params = []\n      } else if (binding.value === undefined && !binding.modifiers.global && options.assumeGlobal) {\n        // Fall back to global if no value is provided\n        verb = verbArg\n        subject = GlobalRule\n        params = []\n      }\n\n      if (options.assumeGlobal && !subject) {\n        subject = GlobalRule\n        params = params || []\n        verb = verb || verbArg\n      }\n\n      if (!verb || !subject) {\n        throw new Error('Missing verb or subject')\n      }\n\n      const aclMethod =\n        (binding.modifiers.some && 'some') ||\n        (binding.modifiers.every && 'every') ||\n        'can'\n\n      const ok = acl[aclMethod](userAccessor(), verb, subject, ...params)\n      const not = binding.modifiers.not\n\n      if ((ok && not) || (!ok && !not)) {\n        if (behaviour === 'hide') {\n          commentNode(el, vnode)\n        } else if (behaviour === 'disable') {\n          el.disabled = true\n        } else if (behaviour === 'readonly') {\n          el.readOnly = true\n        }\n      }\n    })\n\n    /* define helpers */\n    if (options.helper) {\n      const helper = `$${options.directive}`\n      Vue.prototype[helper] = function () {\n        return acl.can(userAccessor(), ...arguments)\n      }\n      Vue.prototype[helper].not = function () {\n        return !acl.can(userAccessor(), ...arguments)\n      }\n      Vue.prototype[helper].every = function () {\n        return acl.every(userAccessor(), ...arguments)\n      }\n      Vue.prototype[helper].some = function () {\n        return acl.some(userAccessor(), ...arguments)\n      }\n    }\n  }\n}\n\n/**\n * Create comment node\n *\n * @private\n * @author https://stackoverflow.com/questions/43003976/a-custom-directive-similar-to-v-if-in-vuejs#43543814\n */\nfunction commentNode(el, vnode) {\n  const comment = document.createComment(' ')\n\n  Object.defineProperty(comment, 'setAttribute', {\n    value: () => undefined\n  })\n\n  vnode.text = ' '\n  vnode.elm = comment\n  vnode.isComment = true\n  vnode.tag = undefined\n  vnode.data.directives = undefined\n\n  if (vnode.componentInstance) {\n    vnode.componentInstance.$el = comment\n  }\n\n  if (el.parentNode) {\n    el.parentNode.replaceChild(comment, el)\n  }\n}\n\n/**\n * Maps binding.value of type array to expression tuple\n */\nconst arrayToExprTpl = ({arg, value}) => ([\n  arg || value[0],\n  arg ? value[0] : value[1],\n  arg ? value.slice(1) : value.slice(2)\n])\n\n/**\n * Maps binding.value of type array to global expression tuple\n */\nconst arrayToGlobalExprTpl = ({arg, value}) => ([\n  arg || value[0],\n  GlobalRule,\n  arg ? value : value.slice(1)\n])\n\n/**\n * Maps binding.value of type string to expression tuple\n */\nconst stringToExprTpl = ({arg, value, modifiers}, vnode, options) => {\n  let [verb, subject] = arg ? [arg, value] : value.split(' ')\n\n  if (subject && modifiers.global) {\n    throw new Error('You cannot provide subject and use global modifier at the same time')\n  }\n\n  if (\n    typeof subject === 'string' &&\n    options.caseMode &&\n    subject[0].match(/[a-z]/)\n  ) {\n    subject = vnode.context[subject]\n  }\n\n  return [verb, subject, []]\n}\n"],"names":["t","e","name","[object Object]","strict","this","rules","Map","policies","registry","WeakMap","r","s","i","n","subjectMapper","Array","isArray","forEach","get","set","o","c","Error","beforeAll","Boolean","some","can","every","prototype","arguments","has","constructor","delete","removeRules","removePolicy","install","Vue","user","setupCallback","options","userAccessor","Object","assign","acl","assumeGlobal","caseMode","debug","directive","failRoute","helper","Acl","router","canNavigate","verb","subject","otherArgs","chainCans","metas","to","from","fail","chain","reduce","meta","then","result","nextPromise","Promise","resolve","split","GlobalRule","metaToStatementPair","catch","error","console","getFail","beforeEach","next","matched","filter","route","map","path","el","binding","vnode","verbArg","params","behaviour","modifiers","disable","arg","value","global","arrayToGlobalExprTpl","arrayToExprTpl","stringToExprTpl","_typeof","undefined","aclMethod","ok","not","commentNode","disabled","readOnly","comment","document","createComment","defineProperty","text","elm","isComment","tag","data","directives","componentInstance","$el","parentNode","replaceChild","slice","match","context"],"mappings":"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"}